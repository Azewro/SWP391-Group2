<%@ page contentType="text/html; charset=UTF-8" language="java" %>
<%@ page import="java.util.List" %>
<%@ page import="model.User, model.Role" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Font Awesome (icon ƒë·∫πp h∆°n) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<%@ include file="header.jsp" %>


<div id="layoutSidenav">
    <jsp:include page="sidebar.jsp"/>
    <div id="layoutSidenav_content">
        <main class="content-wrapper">
            <div class="container mt-4">
                <!-- Ti√™u ƒë·ªÅ -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="fw-bold"><i class="fas fa-chart-line"></i> Dashboard</h2>
                    <span class="text-muted">Ch√†o m·ª´ng, Admin üëã</span>
                </div>

                <!-- T·ªïng quan -->
                <h5 class="text-muted mb-3">üìä T·ªïng quan</h5>
                <div class="row g-4">
                    <c:forEach var="stat" items="${dashboardStats}">
                        <div class="col-md-3">
                            <div class="card text-bg-${stat.color} shadow-sm text-center rounded-3">
                                <div class="card-body">
                                    <h6 class="card-title"><i class="${stat.icon}"></i> ${stat.label}</h6>
                                    <p class="card-text fs-4 fw-bold">${stat.value}</p>
                                </div>
                            </div>
                        </div>
                    </c:forEach>
                </div>

                <!-- Bi·ªÉu ƒë·ªì -->
                <h5 class="text-muted mt-5 mb-3">üìà Doanh thu & V√© b√°n trong 7 ng√†y</h5>
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card shadow-sm rounded-3">
                            <div class="card-body">
                                <h6 class="card-title"><i class="fas fa-coins"></i> Doanh thu 7 ng√†y</h6>
                                <canvas id="revenueChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card shadow-sm rounded-3">
                            <div class="card-body">
                                <h6 class="card-title"><i class="fas fa-ticket-alt"></i> V√© b√°n 7 ng√†y</h6>
                                <canvas id="ticketChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>



                <div class="card shadow-sm rounded-3 mb-4">
                    <h5 class="text-muted mt-5 mb-3">üß≠ Ph√¢n b·ªë ƒë√°nh gi√° theo s·ªë sao</h5>
                    <div class="card-body">
                        <h6 class="card-title"><i class="fas fa-star"></i> Th·ªëng k√™ feedback theo sao</h6>
                        <canvas id="feedbackPieChart" height="250" style="max-width: 400px; margin: auto;"></canvas>
                    </div>
                </div>
                <!-- Ph·∫£n h·ªìi ch·ªù duy·ªát -->
                <h5 class="text-muted mt-5 mb-3">üí¨ Ph·∫£n h·ªìi ch·ªù duy·ªát</h5>
                <div class="card shadow-sm rounded-3">
                    <div class="card-body">
                        <c:choose>
                            <c:when test="${not empty pendingFeedbacks}">
                                <c:forEach var="fb" items="${pendingFeedbacks}" varStatus="loop" begin="0" end="2">
                                    <div class="mb-3 border-bottom pb-2">
                                        <strong>Ng∆∞·ªùi d√πng:</strong> ${fb.userName}<br>
                                        <strong>ƒê√°nh gi√°:</strong> ${fb.rating}‚òÖ<br>
                                        <strong>B√¨nh lu·∫≠n:</strong> ${fb.comment}
                                    </div>
                                </c:forEach>
                            </c:when>
                            <c:otherwise>
                                <p>Kh√¥ng c√≥ ph·∫£n h·ªìi ch·ªù duy·ªát.</p>
                            </c:otherwise>
                        </c:choose>

                        <div class="text-end">
                            <a href="http://localhost:8080/SWP391_Group2_war_exploded/admin/feedback?action=pending" class="btn btn-outline-primary btn-sm">
                                Xem t·∫•t c·∫£ <i class="fas fa-arrow-right"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Chart.js CDN -->
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

            <!-- Bi·ªÉu ƒë·ªì Dashboard -->
            <script>
                const revenueCtx = document.getElementById('revenueChart').getContext('2d');
                const ticketCtx = document.getElementById('ticketChart').getContext('2d');

                const labels = ${chartLabels}; // v√≠ d·ª•: ['"T2"', '"T3"', '"T4"', '"T5"', '"T6"', '"T7"', '"CN"']
                const revenueData = ${revenueData}; // v√≠ d·ª•: [1200000, 1500000, 1100000, 1800000, 1400000, 2000000, 1700000]
                const ticketData = ${ticketData};   // v√≠ d·ª•: [20, 25, 18, 30, 22, 35, 28]

                new Chart(revenueCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Doanh thu (‚Ç´)',
                            data: revenueData,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    }
                });

                new Chart(ticketCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'S·ªë v√© b√°n',
                            data: ticketData,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        }]
                    }
                });

                const pieCtx = document.getElementById('feedbackPieChart').getContext('2d');
                const pieData = ${pieFeedbackData}; // v√≠ d·ª•: [2, 5, 10, 15, 8] cho 1‚≠ê ‚Üí 5‚≠ê

                new Chart(pieCtx, {
                    type: 'pie',
                    data: {
                        labels: ['1 ‚≠ê', '2 ‚≠ê', '3 ‚≠ê', '4 ‚≠ê', '5 ‚≠ê'],
                        datasets: [{
                            label: 'S·ªë l∆∞·ª£ng',
                            data: pieData,
                            backgroundColor: [
                                '#dc3545', '#fd7e14', '#ffc107', '#0d6efd', '#198754'
                            ]
                        }]
                    }
                });

            </script>

        </main>
    </div>
</div>